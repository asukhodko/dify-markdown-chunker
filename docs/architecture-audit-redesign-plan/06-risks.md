# План Редизайна: Риски и Митигация

## Обзор рисков

| # | Риск | Вероятность | Влияние | Приоритет |
|---|------|-------------|---------|-----------|
| R1 | Потеря функциональности | Средняя | Высокое | 1 |
| R2 | Регрессии в обработке | Средняя | Высокое | 2 |
| R3 | Несовместимость API | Низкая | Высокое | 3 |
| R4 | Потеря edge cases | Средняя | Среднее | 4 |
| R5 | Ухудшение производительности | Низкая | Среднее | 5 |
| R6 | Недооценка трудозатрат | Средняя | Среднее | 6 |

---

## R1: Потеря функциональности

### Описание
При упрощении архитектуры можно потерять важную функциональность, которая была добавлена в MC-* fixes.

### Вероятность: Средняя

### Влияние: Высокое
- Пользователи получат некорректные результаты
- Потеря доверия к библиотеке

### Митигация

1. **Property-based тесты** — 8 тестов для доменных свойств
2. **Сравнение результатов** — прогнать на реальных документах
3. **Инкрементальный подход** — не удалять старый код до проверки

### Индикаторы

- Property-based тесты не проходят
- Результаты на реальных документах отличаются

### План действий при срабатывании

1. Остановить редизайн
2. Проанализировать расхождения
3. Добавить недостающую логику в новый код
4. Повторить тесты

---

## R2: Регрессии в обработке

### Описание
Новый код может некорректно обрабатывать некоторые типы документов.

### Вероятность: Средняя

### Влияние: Высокое

### Митигация

1. **Тестовый корпус из 15+ реальных документов**
   - code_heavy/ — python_tutorial.md, api_reference.md, code_snippets.md
   - structured/ — user_guide.md, architecture_doc.md, faq.md
   - mixed/ — readme.md, changelog.md, contributing.md
   - simple/ — notes.md, todo.md, blog_post.md
   - edge_cases/ — nested_code_blocks.md, large_tables.md, mixed_line_endings.md

2. **Автоматическое сравнение с baseline**
   ```python
   def compare_results(baseline: dict, new_results: dict) -> dict:
       differences = {}
       for doc, old in baseline.items():
           new = new_results.get(doc)
           if len(old['chunks']) != len(new['chunks']):
               diff_pct = abs(len(old['chunks']) - len(new['chunks'])) / len(old['chunks']) * 100
               if diff_pct > 5:  # Threshold
                   differences[doc] = {'chunk_count_diff': diff_pct}
       return differences
   ```

3. **Количественные критерии** — >5% разница требует review

### Индикаторы

- Количество чанков отличается
- Содержимое чанков отличается
- Метаданные отличаются

---

## R3: Несовместимость API

### Описание
Изменение публичного API может сломать код пользователей.

### Вероятность: Низкая

### Влияние: Высокое

### Митигация

1. **Сохранить публичный API**
   - `MarkdownChunker` — главный класс
   - `ChunkConfig` — конфигурация
   - `Chunk` — результат
   - `chunk_text()`, `chunk_file()` — convenience функции

2. **Deprecation warnings** — для удаляемых методов
   ```python
   @deprecated("Use chunk(include_analysis=True) instead")
   def chunk_with_analysis(self, ...):
       ...
   ```

3. **Версионирование** — major version bump (2.0.0)

### Индикаторы

- Импорты не работают
- Методы не найдены
- Сигнатуры изменились

---

## R4: Потеря edge cases

### Описание
Старый код содержит много обработки граничных случаев, которая может быть потеряна.

### Вероятность: Средняя

### Влияние: Среднее

### Митигация

1. **Анализ комментариев** — найти все `# FIX:`, `# CRITICAL:`, `# Edge case:`
2. **Сохранить regression тесты** — для известных багов
3. **Документировать edge cases** — в отдельном файле

### Известные edge cases

| # | Edge case | Где обрабатывается |
|---|-----------|-------------------|
| 1 | Вложенные code blocks | code_strategy.py |
| 2 | Таблица в конце документа | table_strategy.py |
| 3 | Очень длинная строка | base.py |
| 4 | Unicode в заголовках | structural_strategy.py |
| 5 | Смешанные переносы строк | text_normalizer.py |

---

## R5: Ухудшение производительности

### Описание
Новый код может работать медленнее из-за неоптимальной реализации.

### Вероятность: Низкая

### Влияние: Среднее

### Митигация

1. **Бенчмарки** — измерить до и после
   ```python
   def benchmark():
       docs = load_test_docs()
       
       # Старый код
       old_times = []
       for doc in docs:
           start = time.time()
           old_chunker.chunk(doc)
           old_times.append(time.time() - start)
       
       # Новый код
       new_times = []
       for doc in docs:
           start = time.time()
           new_chunker.chunk(doc)
           new_times.append(time.time() - start)
       
       assert mean(new_times) <= mean(old_times) * 1.1  # Не более 10% медленнее
   ```

2. **Профилирование** — найти узкие места
3. **Оптимизация** — если нужно

### Индикаторы

- Время обработки увеличилось > 10%
- Использование памяти увеличилось > 20%

---

## R6: Недооценка трудозатрат

### Описание
Редизайн может занять больше времени, чем планировалось.

### Вероятность: Средняя

### Влияние: Среднее

### Митигация

1. **Буфер времени** — +30% к оценкам
2. **Приоритизация** — сначала критичное
3. **Инкрементальный подход** — можно остановиться на любой фазе

### Оценки с буфером

| Фаза | Базовая оценка | С буфером |
|------|----------------|-----------|
| Фаза 1 | 2-3 дня | 3-4 дня |
| Фаза 2 | 4-5 дней | 5-7 дней |
| Фаза 3 | 5-6 дней | 7-8 дней |
| Фаза 4 | 3-4 дня | 4-5 дней |
| Фаза 5 | 2-3 дня | 3-4 дня |
| **Итого** | **16-21 день** | **22-28 дней** |

---

## Количественные критерии rollback

| Метрика | Порог | Действие |
|---------|-------|----------|
| Chunk count difference | >5% на тестовом корпусе | Review required |
| Content loss | >1% | **Rollback** |
| Property test failures | Any | **Rollback** |
| Table integrity errors | Any new | **Rollback** |
| Fence balance errors | >1% increase | Review required |
| Performance degradation | >20% slower | Review required |

### Скрипт сравнения

```bash
# Сравнение результатов
python scripts/compare_results.py --baseline baseline.json --new new_results.json

# Вывод:
# Total documents: 15
# Documents with differences: 2
# Chunk count diff > 5%: 1 (doc: large_tables.md, diff: 8%)
# Content loss > 1%: 0
# VERDICT: REVIEW REQUIRED
```

## Стратегия отката

### Когда откатываться

1. Property-based тесты не проходят после 3 попыток исправления
2. **Content loss >1% на тестовом корпусе**
3. **Любые новые table integrity или fence balance errors**
4. Трудозатраты превысили оценку в 2 раза

### Как откатываться

1. Сохранить новый код в ветке `redesign-attempt-1`
2. Вернуться к `main`
3. Применить точечные исправления вместо полного редизайна
4. Документировать причины отката

### Альтернативный план

Если полный редизайн не удаётся:

1. **Частичное упрощение**
   - Удалить только deprecated код
   - Объединить только types.py
   - Упростить только конфигурацию

2. **Инкрементальный рефакторинг**
   - Один файл за раз
   - Без изменения архитектуры
   - Только cleanup

---

## Чеклист перед началом

- [ ] Property-based тесты написаны и проходят
- [ ] Тестовые документы подготовлены
- [ ] Бенчмарки настроены
- [ ] CI настроен
- [ ] Ветка `redesign` создана
- [ ] Команда уведомлена
