# План Редизайна: Риски и Митигация

## Обзор рисков

| # | Риск | Вероятность | Влияние | Приоритет |
|---|------|-------------|---------|-----------|
| R1 | Потеря функциональности | Средняя | Высокое | 1 |
| R2 | Регрессии в обработке | Средняя | Высокое | 2 |
| R3 | Несовместимость API | Низкая | Высокое | 3 |
| R4 | Потеря edge cases | Средняя | Среднее | 4 |
| R5 | Ухудшение производительности | Низкая | Среднее | 5 |
| R6 | Недооценка трудозатрат | Средняя | Среднее | 6 |

---

## R1: Потеря функциональности

### Описание
При упрощении архитектуры можно потерять важную функциональность, которая была добавлена в MC-* fixes.

### Вероятность: Средняя

### Влияние: Высокое
- Пользователи получат некорректные результаты
- Потеря доверия к библиотеке

### Митигация

1. **Property-based тесты** — 8 тестов для доменных свойств
2. **Сравнение результатов** — прогнать на реальных документах
3. **Инкрементальный подход** — не удалять старый код до проверки

### Индикаторы

- Property-based тесты не проходят
- Результаты на реальных документах отличаются

### План действий при срабатывании

1. Остановить редизайн
2. Проанализировать расхождения
3. Добавить недостающую логику в новый код
4. Повторить тесты

---

## R2: Регрессии в обработке

### Описание
Новый код может некорректно обрабатывать некоторые типы документов.

### Вероятность: Средняя

### Влияние: Высокое

### Митигация

1. **Тестовый набор документов**
   - code_heavy.md — много кода
   - structured.md — много заголовков
   - mixed.md — смешанный контент
   - edge_cases.md — граничные случаи

2. **Автоматическое сравнение**
   ```python
   def compare_results(old_result, new_result):
       assert len(old_result.chunks) == len(new_result.chunks)
       for old, new in zip(old_result.chunks, new_result.chunks):
           assert old.content == new.content
   ```

3. **Ручная проверка** — визуальный осмотр результатов

### Индикаторы

- Количество чанков отличается
- Содержимое чанков отличается
- Метаданные отличаются

---

## R3: Несовместимость API

### Описание
Изменение публичного API может сломать код пользователей.

### Вероятность: Низкая

### Влияние: Высокое

### Митигация

1. **Сохранить публичный API**
   - `MarkdownChunker` — главный класс
   - `ChunkConfig` — конфигурация
   - `Chunk` — результат
   - `chunk_text()`, `chunk_file()` — convenience функции

2. **Deprecation warnings** — для удаляемых методов
   ```python
   @deprecated("Use chunk(include_analysis=True) instead")
   def chunk_with_analysis(self, ...):
       ...
   ```

3. **Версионирование** — major version bump (2.0.0)

### Индикаторы

- Импорты не работают
- Методы не найдены
- Сигнатуры изменились

---

## R4: Потеря edge cases

### Описание
Старый код содержит много обработки граничных случаев, которая может быть потеряна.

### Вероятность: Средняя

### Влияние: Среднее

### Митигация

1. **Анализ комментариев** — найти все `# FIX:`, `# CRITICAL:`, `# Edge case:`
2. **Сохранить regression тесты** — для известных багов
3. **Документировать edge cases** — в отдельном файле

### Известные edge cases

| # | Edge case | Где обрабатывается |
|---|-----------|-------------------|
| 1 | Вложенные code blocks | code_strategy.py |
| 2 | Таблица в конце документа | table_strategy.py |
| 3 | Очень длинная строка | base.py |
| 4 | Unicode в заголовках | structural_strategy.py |
| 5 | Смешанные переносы строк | text_normalizer.py |

---

## R5: Ухудшение производительности

### Описание
Новый код может работать медленнее из-за неоптимальной реализации.

### Вероятность: Низкая

### Влияние: Среднее

### Митигация

1. **Бенчмарки** — измерить до и после
   ```python
   def benchmark():
       docs = load_test_docs()
       
       # Старый код
       old_times = []
       for doc in docs:
           start = time.time()
           old_chunker.chunk(doc)
           old_times.append(time.time() - start)
       
       # Новый код
       new_times = []
       for doc in docs:
           start = time.time()
           new_chunker.chunk(doc)
           new_times.append(time.time() - start)
       
       assert mean(new_times) <= mean(old_times) * 1.1  # Не более 10% медленнее
   ```

2. **Профилирование** — найти узкие места
3. **Оптимизация** — если нужно

### Индикаторы

- Время обработки увеличилось > 10%
- Использование памяти увеличилось > 20%

---

## R6: Недооценка трудозатрат

### Описание
Редизайн может занять больше времени, чем планировалось.

### Вероятность: Средняя

### Влияние: Среднее

### Митигация

1. **Буфер времени** — +30% к оценкам
2. **Приоритизация** — сначала критичное
3. **Инкрементальный подход** — можно остановиться на любой фазе

### Оценки с буфером

| Фаза | Базовая оценка | С буфером |
|------|----------------|-----------|
| Фаза 1 | 2-3 дня | 3-4 дня |
| Фаза 2 | 4-5 дней | 5-7 дней |
| Фаза 3 | 5-6 дней | 7-8 дней |
| Фаза 4 | 3-4 дня | 4-5 дней |
| Фаза 5 | 2-3 дня | 3-4 дня |
| **Итого** | **16-21 день** | **22-28 дней** |

---

## Стратегия отката

### Когда откатываться

1. Property-based тесты не проходят после 3 попыток исправления
2. Результаты на реальных документах критически отличаются
3. Трудозатраты превысили оценку в 2 раза

### Как откатываться

1. Сохранить новый код в ветке `redesign-attempt-1`
2. Вернуться к `main`
3. Применить точечные исправления вместо полного редизайна
4. Документировать причины отката

### Альтернативный план

Если полный редизайн не удаётся:

1. **Частичное упрощение**
   - Удалить только deprecated код
   - Объединить только types.py
   - Упростить только конфигурацию

2. **Инкрементальный рефакторинг**
   - Один файл за раз
   - Без изменения архитектуры
   - Только cleanup

---

## Чеклист перед началом

- [ ] Property-based тесты написаны и проходят
- [ ] Тестовые документы подготовлены
- [ ] Бенчмарки настроены
- [ ] CI настроен
- [ ] Ветка `redesign` создана
- [ ] Команда уведомлена
