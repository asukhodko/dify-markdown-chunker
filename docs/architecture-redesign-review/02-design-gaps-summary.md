# Сводка пробелов в новом дизайне

## Критический вывод

**Статус: ✅ ГОТОВ К РЕАЛИЗАЦИИ**

Все критические пробелы исправлены. Оставшиеся — оптимизации качества, не блокеры.

### Критические пробелы (исправлены):
- ✅ GAP-2: oversize_tolerance добавлен (MC-001)
- ✅ GAP-3: _validate_code_fence_balance добавлен (Phase 1.1, PROP-6)
- ✅ GAP-4: Сортировка добавлена в _post_process (PROP-3)
- ✅ GAP-7: 50% overlap limit добавлен (Phase 2.2)
- ✅ GAP-8: Симметричное обрезание добавлено (Phase 2.1)

### Частично исправленные (достаточно для MVP):
- ✅ GAP-1: Block-based overlap → проверка code blocks в _apply_overlap()

### Некритичные (оптимизации качества):
- ⚠️ GAP-5: Нормализация размеров — не влияет на PROP свойства
- ⚠️ GAP-6: URL pools — редкий edge case
- ⚠️ GAP-9: FallbackStrategy структура — fallback, качество вторично
- ⚠️ GAP-10: Валидация header_path — метаданные, не контент
- ⚠️ GAP-11: Группировка маленьких элементов — оптимизация

---

## Критические пробелы (блокируют рефакторинг)

### GAP-1: ✅ ЧАСТИЧНО ИСПРАВЛЕНО — Block-based overlap

**Проблема:** Новый `Chunker._apply_overlap()` использует простое обрезание по символам.

**Решение:** Добавлена проверка на code blocks в `_apply_overlap()`:
```python
# MC-003 fix: Не разрезать code blocks
if '```' in overlap:
    fence_pos = overlap.rfind('```')
    if overlap.count('```') % 2 == 1:
        overlap = overlap[fence_pos + 3:].lstrip()
```

**Статус:** Достаточно для MVP. Полный block-based overlap можно добавить позже если нужно.

**Файл:** `docs/architecture-audit-to-be/04-components.md`

---

### GAP-2: ✅ ИСПРАВЛЕНО — 20% tolerance для сохранения секций

**Проблема:** MC-001 fix позволяет секциям быть на 20% больше max_chunk_size, чтобы не разбивать их.

**Решение:** Добавлен `oversize_tolerance: float = 0.2` в ChunkConfig и использование в стратегиях.

**Файлы:** 
- `docs/architecture-audit-to-be/03-config.md`
- `docs/architecture-audit-to-be/05-strategies.md`

---

### GAP-3: ✅ ИСПРАВЛЕНО — Валидация code fence balance

**Проблема:** `_validate_code_fence_balance()` проверяет, что каждый чанк имеет чётное количество ```.

**Решение:** Добавлен `_validate_code_fence_balance()` в BaseStrategy.

**Файл:** `docs/architecture-audit-to-be/05-strategies.md`

---

### GAP-4: ✅ ИСПРАВЛЕНО — Сортировка чанков по позиции

**Проблема:** Чанки должны быть отсортированы по start_line для PROP-3 (Monotonic Ordering).

**Решение:** Добавлена сортировка в `_post_process()`.

**Файл:** `docs/architecture-audit-to-be/04-components.md`

---

### GAP-5: Нет нормализации размеров чанков

**Проблема:** MC-004 fix объединяет маленькие чанки для уменьшения разброса размеров.

**Текущее решение:** `chunk_size_normalizer.py`

**Рекомендация:** 
- Вариант A: Добавить опциональную нормализацию
- Вариант B: Убедиться, что стратегии создают равномерные чанки

---

## Важные пробелы (желательно исправить)

### GAP-6: Нет детекции URL pools

**Проблема:** MC-005 fix сохраняет блоки из 3+ URL вместе.

**Текущее решение:** `block_packer.py:466-500`

**Рекомендация:** Добавить в CodeAwareStrategy или игнорировать (низкий приоритет)

---

### GAP-7: ✅ ИСПРАВЛЕНО — Лимит overlap (50%)

**Проблема:** Phase 2.2 fix ограничивает overlap до 50% размера чанка.

**Решение:** Добавлен `max_overlap = min(config.overlap_size, len(prev_content) // 2)` в `_apply_overlap()`.

**Файл:** `docs/architecture-audit-to-be/04-components.md`

---

### GAP-8: ✅ ИСПРАВЛЕНО — Симметричное обрезание overlap

**Проблема:** Phase 2.1 fix использует `strip()` для симметрии.

**Решение:** Добавлен `overlap = overlap.strip()` и поиск границы слова в `_apply_overlap()`.

**Файл:** `docs/architecture-audit-to-be/04-components.md`

---

### GAP-9: FallbackStrategy не сохраняет markdown структуру

**Проблема:** Текущая SentencesStrategy имеет логику сохранения заголовков, списков, таблиц.

**Текущее решение:** `sentences_strategy.py:158-160, 267-278`

**Рекомендация:** Перенести логику в FallbackStrategy

---

### GAP-10: Нет валидации header_path

**Проблема:** MC-006 fix валидирует и исправляет header_path.

**Текущее решение:** `header_path_validator.py`

**Рекомендация:** Добавить валидацию в StructuralStrategy

---

### GAP-11: Нет группировки маленьких элементов

**Проблема:** ListStrategy группирует элементы, чтобы избежать micro-chunks.

**Текущее решение:** `list_strategy.py:416-430`

**Рекомендация:** Добавить логику группировки в BaseStrategy или стратегии

---

## Матрица влияния на доменные свойства

| Пробел | PROP-1 | PROP-2 | PROP-3 | PROP-4 | PROP-5 | PROP-6 | PROP-7 | PROP-8 | Статус |
|--------|--------|--------|--------|--------|--------|--------|--------|--------|--------|
| GAP-1 | - | - | - | - | - | ✅ | ✅ | - | Исправлен |
| GAP-2 | - | ✅ | - | - | - | - | - | - | Исправлен |
| GAP-3 | - | - | - | - | - | ✅ | - | - | Исправлен |
| GAP-4 | - | - | ✅ | - | - | - | - | - | Исправлен |
| GAP-5 | - | ⚠️ | - | - | - | - | - | - | Некритичен |
| GAP-6 | ⚠️ | - | - | - | - | - | - | - | Некритичен |
| GAP-7 | - | ✅ | - | - | - | - | - | - | Исправлен |
| GAP-8 | - | - | - | - | - | - | - | - | Исправлен |
| GAP-9 | ⚠️ | - | - | - | - | - | - | - | Некритичен |
| GAP-10 | - | - | - | - | - | - | - | - | Некритичен |
| GAP-11 | - | ⚠️ | - | - | - | - | - | - | Некритичен |

**Легенда:** ✅ = исправлено, ⚠️ = может нарушить (некритично), ❌ = нарушает

---

## Рекомендации по доработке дизайна

### ✅ Выполненные изменения

1. ~~**Добавить 20% tolerance**~~ — ✅ GAP-2 исправлен
2. ~~**Добавить валидацию code fence**~~ — ✅ GAP-3 исправлен
3. ~~**Добавить сортировку**~~ — ✅ GAP-4 исправлен
4. ~~**Добавить лимит overlap 50%**~~ — ✅ GAP-7 исправлен
5. ~~**Добавить симметричное обрезание**~~ — ✅ GAP-8 исправлен

### Оставшиеся изменения (желательные)

1. **GAP-1: Доработать overlap** — проверка на code blocks добавлена, но упрощена
2. **GAP-5: Нормализация размеров** — можно добавить позже
3. **GAP-6: URL pools** — низкий приоритет
4. **GAP-9: FallbackStrategy структура** — можно добавить позже
5. **GAP-10: Валидация header_path** — можно добавить позже
6. **GAP-11: Группировка маленьких элементов** — можно добавить позже

---

## Решение

**Статус: ✅ ЗЕЛЁНЫЙ СВЕТ — дизайн готов к реализации.**

### Все критические пробелы исправлены:
- ✅ GAP-1: MC-003 overlap (проверка code blocks)
- ✅ GAP-2: MC-001 oversize_tolerance
- ✅ GAP-3: Phase 1.1 code fence balance
- ✅ GAP-4: PROP-3 sorting
- ✅ GAP-7: Phase 2.2 overlap limit
- ✅ GAP-8: Phase 2.1 symmetric truncation

### Некритичные пробелы (оптимизации):
- ⚠️ GAP-5: Нормализация размеров — добавить если нужно
- ⚠️ GAP-6: URL pools — добавить если нужно
- ⚠️ GAP-9: FallbackStrategy — добавить если нужно
- ⚠️ GAP-10: header_path валидация — добавить если нужно
- ⚠️ GAP-11: Группировка элементов — добавить если нужно

### Рекомендация:
1. **Начать реализацию** — все критические проверки пройдены
2. **Мониторить regression тесты** — если падают, добавить недостающую логику
3. **Добавлять оптимизации по мере необходимости** — GAP-5, 6, 9, 10, 11
